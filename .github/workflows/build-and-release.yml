name: Build and Release KBD Trainer

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

env:
  BUILD_TYPE: Release

jobs:
  build-windows:
    runs-on: windows-2022
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0

    - name: Set up MSVC
      uses: microsoft/setup-msbuild@v2

    - name: Install NSIS
      run: |
        choco install nsis -y
        echo "C:\Program Files (x86)\NSIS" >> $env:GITHUB_PATH

    - name: Install WiX Toolset v3.14
      run: |
        $wixUrl = "https://github.com/wixtoolset/wix3/releases/download/wix3141rtm/wix314-binaries.zip"
        $wixPath = "$env:RUNNER_TEMP\wix314"
        Invoke-WebRequest -Uri $wixUrl -OutFile "$env:RUNNER_TEMP\wix314.zip"
        Expand-Archive -Path "$env:RUNNER_TEMP\wix314.zip" -DestinationPath $wixPath
        echo "$wixPath" >> $env:GITHUB_PATH

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}}

    - name: Build
      run: cmake --build build --config ${{env.BUILD_TYPE}}

    - name: Create ZIP Package
      run: |
        cd build
        cpack -G ZIP

    - name: Create NSIS Installer
      run: |
        cd build
        cpack -G NSIS

    - name: Create WiX MSI Package
      run: |
        cd build
        cpack -G WIX

    - name: List generated packages
      run: |
        cd build
        Get-ChildItem "KBD Trainer-*.zip", "KBD Trainer-*.exe", "KBD Trainer-*.msi" | Format-Table Name, Length

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: kbd-trainer-windows-packages
        path: |
          build/KBD Trainer-*.zip
          build/KBD Trainer-*.exe
          build/KBD Trainer-*.msi
        retention-days: 30

    - name: Create Release (on tag push)
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v2
      with:
        files: |
          build/KBD Trainer-*.zip
          build/KBD Trainer-*.exe
          build/KBD Trainer-*.msi
        body: |
          ## KBD Trainer Release ${{ github.ref_name }}
          
          ### ğŸ“¦ Installation Options
          
          **Choose the package that best fits your needs:**
          
          #### ğŸ”§ **Windows Installer (NSIS)** - `KBD Trainer-*-win64.exe`
          - **Recommended for most users**
          - Professional installer with setup wizard
          - Creates desktop and Start Menu shortcuts
          - Easy uninstall through Control Panel
          - Size: ~1.8 MB
          
          #### ğŸ¢ **Enterprise MSI Package** - `KBD Trainer-*-win64.msi`
          - **For corporate environments**
          - Group Policy deployment support
          - Silent installation capability
          - Windows Installer technology
          - Size: ~2.5 MB
          
          #### ğŸ“ **Portable ZIP Archive** - `KBD Trainer-*-win64.zip`
          - **For portable/USB installations**
          - No installation required
          - Extract and run anywhere
          - Perfect for testing or temporary use
          - Size: ~2.2 MB
          
          ### ğŸ® About KBD Trainer
          
          Korean Backdash training tool for Tekken players. Practice your Korean Backdash timing and improve your movement skills!
          
          ### ğŸš€ What's New
          
          - Professional packaging system with multiple distribution formats
          - Enhanced build system with automated releases
          - Complete documentation and setup guides
          
          ### ğŸ’» System Requirements
          
          - Windows 10/11 (64-bit)
          - DirectX compatible graphics
          - Gamepad or keyboard input
          
          ---
          
          *Built automatically with GitHub Actions*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-info:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: Build Status
      run: |
        echo "âœ… Automated build triggered for KBD Trainer"
        echo "ğŸ“¦ Building Windows packages: ZIP, NSIS, MSI"
        echo "ğŸš€ Artifacts will be available in the Actions tab"
        echo "ğŸ·ï¸ Create a tag (git tag v1.0.0 && git push --tags) to trigger a release"
